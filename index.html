<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>SportCast</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-100">

<header class="header-gradient shadow-lg p-6 text-center text-white text-3xl font-semibold">
    SportCast –ö–æ–º–µ–Ω—Ç–∞—Ä–∏
</header>

<div class="container mx-auto px-4 max-w-4xl mt-8">

    <div class="flex flex-wrap gap-3 mb-6">
        <input id="videoUrl" type="text"
               class="flex-1 p-3 rounded-xl border border-gray-300"
               placeholder="–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –ª–∏–Ω–∫ –∫—ä–º YouTube –≤–∏–¥–µ–æ...">
        <button onclick="startIngestion()"
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl">
            –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π
        </button>
    </div>

    <div id="status" class="text-lg font-semibold mb-4"></div>

    <h2 class="text-2xl font-semibold mt-10 mb-4">–í–∏–¥–µ–∞</h2>
    <div id="videoList" class="flex flex-col gap-4"></div>

    <h2 class="text-2xl font-semibold mt-10 mb-4">–§–∏–ª—Ç—Ä–∏</h2>

    <div class="flex flex-wrap gap-4 mb-6">
        <select id="sort" class="select-field">
            <option value="most_recent">–ù–∞–π-–Ω–æ–≤–∏</option>
            <option value="most_liked">–ù–∞–π-—Ö–∞—Ä–µ—Å–≤–∞–Ω–∏</option>
        </select>

        <select id="category" class="select-field">
            <option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            <option value="Opinion">–ú–Ω–µ–Ω–∏–µ</option>
            <option value="Question">–í—ä–ø—Ä–æ—Å</option>
            <option value="Feedback">–û–±—Ä–∞—Ç–Ω–∞ –≤—Ä—ä–∑–∫–∞</option>
            <option value="Praise">–ü–æ—Ö–≤–∞–ª–∞</option>
            <option value="Hate Speech">–•–µ–π—Ç</option>
        </select>

        <select id="team" class="select-field">
            <option value="">–í—Å–∏—á–∫–∏ –æ—Ç–±–æ—Ä–∏</option>
            <option value="–¶–°–ö–ê">–¶–°–ö–ê</option>
            <option value="–õ–µ–≤—Å–∫–∏">–õ–µ–≤—Å–∫–∏</option>
            <option value="–ë–æ—Ç–µ–≤ (–ü–ª–æ–≤–¥–∏–≤)">–ë–æ—Ç–µ–≤ (–ü–ª–æ–≤–¥–∏–≤)</option>
            <option value="–õ–æ–∫–æ–º–æ—Ç–∏–≤ (–ü–ª–æ–≤–¥–∏–≤)">–õ–æ–∫–æ–º–æ—Ç–∏–≤ (–ü–ª–æ–≤–¥–∏–≤)</option>
            <option value="–ë–µ—Ä–æ–µ">–ë–µ—Ä–æ–µ</option>
            <option value="–ß–µ—Ä–Ω–æ –º–æ—Ä–µ">–ß–µ—Ä–Ω–æ –º–æ—Ä–µ</option>
            <option value="–õ—É–¥–æ–≥–æ—Ä–µ—Ü">–õ—É–¥–æ–≥–æ—Ä–µ—Ü</option>
        </select>

        <button onclick="loadComments()"
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl">
            –û–±–Ω–æ–≤–∏
        </button>
    </div>

    <div id="comments" class="mt-6"></div>
</div>

<script>
const API = "https://sportscast-production.up.railway.app";
let currentVideoId = null;

function extractVideoId(url) {
    if (!url) return null;
    const m1 = url.match(/v=([a-zA-Z0-9_-]{11})/);
    if (m1) return m1[1];
    const m2 = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
    if (m2) return m2[1];
    return null;
}

async function loadVideos() {
    const res = await fetch(`${API}/videos`);
    const data = await res.json();
    const list = document.getElementById("videoList");
    list.innerHTML = "";

    data.videos.forEach(v => {
        const div = document.createElement("div");
        div.className = "video-card";
        div.onclick = () => {
            currentVideoId = v.video_id;
            loadComments(v.video_id);
        };

        div.innerHTML = `
            <img src="${v.thumbnail}" class="thumb">
            <div>
                <div class="font-semibold text-lg">${v.title}</div>
                <div class="text-sm text-gray-600">${new Date(v.published_at).toLocaleString()}</div>
            </div>
        `;

        list.appendChild(div);
    });
}

async function startIngestion() {
    const url = document.getElementById("videoUrl").value.trim();
    const status = document.getElementById("status");
    const vid = extractVideoId(url);

    if (!vid) { status.innerHTML = "‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –ª–∏–Ω–∫."; return; }

    status.innerHTML = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";

    await fetch(`${API}/ingest_video`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
    });

    currentVideoId = vid;

    setTimeout(async () => {
        await loadComments(vid);
        await loadVideos();
        status.innerHTML = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
    }, 3000);
}

async function loadComments(forceVideo = null) {
    const vid = forceVideo || currentVideoId;
    const sort = document.getElementById("sort").value;
    const cat = document.getElementById("category").value;
    const team = document.getElementById("team").value;

    let url = `${API}/comments?sort_by=${sort}`;
    if (vid) url += `&video_id=${vid}`;
    if (cat) url += `&category=${encodeURIComponent(cat)}`;
    if (team) url += `&team=${encodeURIComponent(team)}`;

    const res = await fetch(url);
    const data = await res.json();

    const box = document.getElementById("comments");
    box.innerHTML = "";

    if (!data.comments.length) {
        box.innerHTML = "<p class='text-gray-600'>–ù—è–º–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏.</p>";
        return;
    }

    data.comments.forEach(c => {
        const div = document.createElement("div");
        div.className = "comment-card";

        div.innerHTML = `
            <div class="text-blue-600 font-semibold">${c.author || "–ê–Ω–æ–Ω–∏–º–µ–Ω"}</div>
            <div class="text-sm text-gray-500">${new Date(c.published_at).toLocaleString()}</div>
            <p class="mt-2">${c.comment_text}</p>
            <div class="text-sm text-gray-700 mt-2">
                üëç ${c.like_count || 0} ¬∑
                ${c.category || "‚Äî"} ¬∑
                ${c.teams ? c.teams.join(", ") : "‚Äî"}
            </div>
        `;

        box.appendChild(div);
    });
}

loadVideos();
loadComments();
</script>

</body>
</html>
